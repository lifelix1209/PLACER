ä¸‹é¢ç»™å‡º **PLACER-TE-BAM v5** çš„â€œå¯è½åœ°ä»£ç æ„å»ºçº§â€æ–¹æ¡ˆï¼šæ¨¡å—åˆ’åˆ†ã€æ•°æ®ç»“æ„ã€å•æ¬¡æµå¼æ¶æ„ã€å…³é”®ç®—æ³•ã€é˜ˆå€¼ä¸é™çº§ç­–ç•¥ã€ä»¥åŠè¾“å‡ºè§„èŒƒã€‚ä½ å¯ä»¥æ®æ­¤ç›´æ¥å¼€ä»“åº“å†™å®ç°ï¼Œä¸éœ€è¦å†è¡¥æ¦‚å¿µã€‚

---

# 0. æ˜ç¡®è¾“å…¥ã€ä¾èµ–ä¸éç›®æ ‡

## è¾“å…¥

* `input.bam`ï¼šé•¿è¯»å¯¹é½ç»“æœï¼ˆONT/PacBioï¼‰ï¼Œå¿…é¡»åŒ…å« `SEQ`ã€‚
* `ref.fa`ï¼šå‚è€ƒåŸºå› ç»„ FASTAï¼ˆç”¨äºå±€éƒ¨å†æ¯”å¯¹ä¸æ–­ç‚¹ç²¾ä¿®ï¼›ä¸åšå…¨é‡é‡æ¯”å¯¹ï¼‰ã€‚
* `te.fa`ï¼šTE åº“åºåˆ—ï¼ˆç”¨äº TE-proxy å’Œ TE å®¶æ—æ³¨é‡Šï¼‰ã€‚
* å¯é€‰ï¼š`ref.fa.fai`ã€`ref.mmi` æˆ–è‡ªå»ºç´¢å¼•ï¼ˆç”¨äºå±€éƒ¨å¯¹é½åŠ é€Ÿï¼‰ã€‚
* å¯é€‰ï¼šBAM å« `MD` tagï¼ˆç”¨äºé”™é…å¯†åº¦å³°åŠ é€Ÿï¼›æ²¡æœ‰åˆ™ç¦ç”¨è¯¥åŠŸèƒ½ï¼‰ã€‚

## çº¦æŸï¼ˆå†™è¿›ä»£ç ä¸æ–‡æ¡£ï¼‰

* **å•æ¬¡é¡ºåºéå† BAM**ï¼šç¦æ­¢å…¨é‡äºŒæ¬¡æ‰«æã€ç¦æ­¢åŸºäº BAM å›è¯»éšæœº seekã€‚
* æ‰€æœ‰åç»­â€œé‡ä»»åŠ¡â€ï¼ˆå±€éƒ¨å†æ¯”å¯¹ / POA / EMï¼‰åªèƒ½ä½¿ç”¨åœ¨ pass 1 å·²æŠ½å–å¹¶ç¼“å­˜çš„ç‰‡æ®µä¸å…ƒä¿¡æ¯ã€‚
* â€œBAM-onlyâ€å®šä¹‰ä¸ºï¼šä¸éœ€è¦ FASTQï¼›ä½†å¿…é¡»æä¾›å‚è€ƒä¸ TE åº“ã€‚

## éç›®æ ‡

* ä¸æ‰¿è¯ºåœ¨â€œæ¯”å¯¹å™¨å®Œå…¨éšèº«ã€ä¸”æ— ä»»ä½• CIGAR/SA/softclip çº¿ç´¢ã€ä¸”å±€éƒ¨ç»Ÿè®¡ä¹Ÿä¸å¼‚å¸¸â€çš„æƒ…å†µä¸‹ä»èƒ½å‘ç°æ’å…¥ã€‚è¯¥ä¿¡æ¯è®ºä¸Šä¸å¯ä¿è¯ã€‚

---

# 1. ä»£ç æ€»ä½“æ¶æ„ï¼ˆå·¥ç¨‹è§†è§’ï¼‰

å»ºè®®ä¸‰å±‚ï¼š

1. **Stream Layerï¼ˆå•é BAM æµï¼‰**

* è´Ÿè´£ï¼šé¡ºåºè¯» BAMã€çª—å£ç»Ÿè®¡ã€è¯»ç‰‡æ®µæŠ½å–ã€è§¦å‘çª—å£å°ç®±ã€æŠŠä»»åŠ¡å†™å…¥é˜Ÿåˆ—ã€‚
* ä¸åšï¼šPOAã€EMã€å±€éƒ¨å¯¹é½ï¼ˆåªåš TE-proxy çš„è¶…è½»é‡åˆ¤åˆ«ä¹Ÿå¯ä»¥åœ¨æ­¤å±‚å®Œæˆï¼‰ã€‚

2. **Task Layerï¼ˆå¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ï¼‰**

* ä»»åŠ¡ç±»å‹ï¼š

  * `COMPONENT_BUILD`ï¼šbin/å­ç¾¤åˆ†è§£ã€å€™é€‰è½ç‚¹é›†åˆæ•´ç†
  * `LOCAL_ALIGN`ï¼šå±€éƒ¨å†æ¯”å¯¹ï¼ˆå—é™å€™é€‰é›†åˆï¼‰
  * `ASSEMBLY`ï¼šGraph-POA / ç”Ÿæˆ contig
  * `COLLAPSE`ï¼šç»“æ„çº§åˆå¹¶
  * `GENOTYPE`ï¼šEM(ALT/REF/NULL)+ç©ºé—´å…ˆéªŒ
* ä»»åŠ¡è¾“å…¥å¿…é¡»å¯åºåˆ—åŒ–ï¼ˆJSON/MsgPack + äºŒè¿›åˆ¶ç‰‡æ®µæ–‡ä»¶ï¼‰ã€‚

3. **Output Layer**

* ç”Ÿæˆä¸¤è½¨è¾“å‡ºï¼š

  * `scientific.vcf`ï¼ˆå« locus-setã€Tier2 å¤šä½ç‚¹ã€è¯æ®å­—æ®µï¼‰
  * `engineering.tsv/bed`ï¼ˆé»˜è®¤ä¸è¾“å‡ºä»£è¡¨åæ ‡ï¼›è‹¥å¯ç”¨åˆ™æ˜ç¡®æ ‡æ³¨â€œDO_NOT_VALIDATE_BY_SINGLE_COORDâ€å¹¶æä¾›é›†åˆï¼‰

å®ç°è¯­è¨€å»ºè®®ï¼šC++(htslib)æˆ–Python(pysam)+C++æ‰©å±•ã€‚åªè¦éµå®ˆå•éåŸåˆ™å³å¯ã€‚

---

# 2. æ ¸å¿ƒæ•°æ®ç»“æ„ï¼ˆç›´æ¥æ˜ å°„åˆ°ä»£ç ç±»/ç»“æ„ä½“ï¼‰

## 2.1 ReadSketchï¼ˆåœ¨ Stream Layer é‡Œäº§ç”Ÿï¼Œè½»é‡ï¼‰

åŒ…å«åç»­æ‰€éœ€çš„æœ€å°ä¿¡æ¯ï¼Œé¿å…å­˜æ•´æ¡ readï¼š

* `read_id`
* `chrom, pos, end, strand`
* `mapq`
* `flag`ï¼ˆsupplementary/secondary/primaryï¼‰
* `cigar_ops`ï¼ˆå‹ç¼©å­˜å‚¨ï¼‰
* `has_SA`ã€`SA_summary`ï¼ˆä»…ä¿ç•™æ–­ç‚¹ç«¯ç‚¹åæ ‡ä¸æ–¹å‘çš„æ‘˜è¦ï¼‰
* `tags_present`: {MD, NM, ...}
* `probe_fragments`: list of `ProbeFragment`

## 2.2 ProbeFragmentï¼ˆGate 1 çš„è¾“å…¥ï¼‰

* `source`: END5/END3/SOFTCLIP/CIGAR_INS/CIGAR_DEL/SA_BREAKPOINT/MD_PEAK(optional)
* `seq`ï¼ˆçŸ­ç‰‡æ®µï¼Œ200â€“400bpï¼Œå¿…è¦æ—¶æ›´çŸ­ï¼‰
* `read_offset_start, read_offset_end`
* `ref_anchor`: (chrom, pos) è¿‘ä¼¼é”šç‚¹ï¼ˆç”¨äºåç»­ç»„ä»¶å½’å±ï¼‰

## 2.3 WindowBufferï¼ˆæ»‘åŠ¨çª—å£ç¼“å†²ï¼‰

* `window_id = (chrom, window_start)`
* `stats`ï¼šclip_bp, clip_reads, ins_events, del_events, sa_reads, te_contig_hits, low_mapq_reads
* `buffered_reads`: list of `ReadSketch`ï¼ˆå—ä¸Šé™æ§åˆ¶ï¼Œè¶…é™åˆ™åˆ†å±‚æŠ½æ ·ä¿ç•™ä»£è¡¨æ€§ï¼‰
* `triggered`: bool
* `sealed`: bool

## 2.4 Componentï¼ˆäº‹ä»¶åˆ†è§£åçš„æœ€å°å•å…ƒï¼‰

* `component_id`
* `locus_set`: list of candidate loci (chrom,pos,score)
* `breakpoint_hypothesis`: orientation, left/right boundary rough
* `core_reads`: list of ReadSketch ids + required fragments pointers
* `all_evidence_summary`: counts/distributions

## 2.5 StructuralRepresentativeï¼ˆç»“æ„çº§åˆå¹¶äº§ç‰©ï¼‰

* `rep_id`
* `locus_set`
* `structure_signature`ï¼šæ–­ç‚¹å‡ ä½•ã€TE å®¶æ—/æ–¹å‘ã€æ’å…¥ä½“é•¿åº¦åŒºé—´ã€5â€™æˆªæ–­çº§åˆ«ã€å€’ç½®æ ‡è®°
* `rep_contig_seq`ï¼ˆPOAå…±è¯†æˆ–ä»£è¡¨åºåˆ—ï¼‰
* `polymorphism_summary`ï¼špolyAé•¿åº¦åˆ†å¸ƒã€å±€éƒ¨SNP/indelæ‘˜è¦ï¼ˆæ³¨é‡Šç”¨ï¼Œä¸è¿›åˆ†å‹æ ¸å¿ƒï¼‰

---

# 3. å•æ¬¡æµå¼éå†ï¼šSensitive æ¨¡å¼å¯è½åœ°å®ç°

## 3.1 å…³é”®åŸåˆ™

* ä¸å…ˆåšå…¨åŸºå› ç»„ W* å†å›è¯»ã€‚
* é‡‡ç”¨â€œæ»‘åŠ¨çª—å£ + è§¦å‘å°ç®± + ä»»åŠ¡æ’é˜Ÿâ€ã€‚

## 3.2 æµç¨‹ï¼ˆä¼ªä»£ç çº§ï¼‰

```
for each alignment in BAM (coordinate-sorted):
    win = get_window(aln.chrom, aln.pos)
    update_stats(win.stats, aln)

    sketches = maybe_extract_readsketch(aln, mode)
    if sketches:
        add_to_buffer(win, sketches)  # with reservoir/stratified sampling

    if not win.triggered and stats_exceed_threshold(win.stats):
        win.triggered = True
        enqueue(GATE1_TASK for win.buffered_reads)

    seal_windows_behind_current_position()
```

### stats_exceed_threshold å…·ä½“åŒ–

ç”¨ç¨³å¥åˆ†ä½æ•°é˜ˆå€¼è€Œä¸æ˜¯å›ºå®šå€¼ï¼ˆè·¨å¹³å°ï¼‰ï¼š

* æ¯æ¡æŸ“è‰²ä½“ç»´æŠ¤åœ¨çº¿ä¼°è®¡å™¨ï¼ˆä¾‹å¦‚ t-digest / PÂ² quantileï¼‰è®°å½•ï¼š

  * clip_bp_per_window
  * large_ins_events_per_window
  * sa_reads_per_window
* è§¦å‘æ¡ä»¶ç¤ºä¾‹ï¼š

  * `clip_bp > Q99_clip` æˆ–
  * `sa_reads > Q99_sa` æˆ–
  * `large_ins_events > Q99_ins` æˆ–
  * `te_contig_hits > 0`ï¼ˆè‹¥è”åˆå‚è€ƒï¼‰
* fast/sensitive çš„åŒºåˆ«æ˜¯é˜ˆå€¼åˆ†ä½æ›´æ¿€è¿›è¿˜æ˜¯æ›´å®½æ¾ã€‚

---

# 4. Gate 1ï¼ˆv5 ä¿®è®¢ç‰ˆï¼Œå¯å®ç°ä¸”ä¸è‡ªæ€ï¼‰

Gate 1 çš„ç›®æ ‡ï¼šç”¨æä½æˆæœ¬æŠŠç»å¤§å¤šæ•°é TE å€™é€‰ä¸¢æ‰ï¼ŒåŒæ—¶ä¸ä¾èµ–â€œåªçœ‹ä¸¤ç«¯â€ã€‚

## 4.1 æ¢é’ˆç‰‡æ®µé›†åˆ P(read)

å¯¹æ¯ä¸ª ReadSketchï¼š

å¿…é€‰ï¼š

* END5, END3ï¼ˆå„ 200â€“400bpï¼‰

æŒ‰æ¡ä»¶åŠ å…¥ï¼š

* SOFTCLIP ç‰‡æ®µï¼ˆè‹¥ Sâ‰¥é˜ˆå€¼ï¼‰
* CIGAR_INSï¼šå¯¹æ¯ä¸ª Iâ‰¥I_min çš„äº‹ä»¶ï¼Œå–å…¶åœ¨ read ä¸Šçš„é‚»åŸŸç‰‡æ®µï¼ˆä¸­å¿ƒÂ±Lï¼‰
* CIGAR_DELï¼šåŒç†ï¼ˆç”¨äºè¯†åˆ«ç»“æ„å¼‚å¸¸åŒºåŸŸï¼‰
* SA_BREAKPOINTï¼šè‹¥æœ‰ SAï¼Œå–æ–­ç‚¹ä¸¤ä¾§é‚»åŸŸç‰‡æ®µ

å¯é€‰ï¼ˆä»… MD å­˜åœ¨ï¼‰ï¼š

* MD_PEAKï¼šä» MD å­—ç¬¦ä¸²ä¸­æ¢å¤é”™é…/ç¼ºå¤±ä½ç½®ï¼Œæ»‘çª—æ‰¾ top-K å³°ï¼Œå¯¹å³°é‚»åŸŸå–ç‰‡æ®µ
  æ—  MDï¼šå®Œå…¨ç¦ç”¨ã€‚

## 4.2 TE-proxy è®¡ç®—ï¼ˆè½»é‡ï¼‰

ä¸åšå…¨ read minimizer æ‰«æï¼Œåªå¯¹ ProbeFragmentï¼š

* é¢„å…ˆä¸º `te.fa` æ„å»º `k-mer set` æˆ– `minimizer sketch`ï¼ˆk=15~19ï¼ŒæŒ‰é”™è¯¯ç‡é€‰ï¼‰ã€‚
* å¯¹ probe è®¡ç®—ï¼š

  * `hit_count`ï¼šå‘½ä¸­ TE k-mer æ•°
  * `hit_density`ï¼šhit_count / probe_length
  * `family_votes`ï¼šå‘½ä¸­åˆ°å“ªç±» TE çš„è®¡æ•°ï¼ˆç”¨äºæ³¨é‡Šä¸åç»­åˆ†è§£ï¼‰

Gate 1 é€šè¿‡è§„åˆ™ï¼ˆç¤ºä¾‹ï¼‰ï¼š

* ä»»ä¸€ probe `hit_density >= d_min` ä¸” `hit_count >= c_min`
* æˆ–å¤š probe ç´¯ç§¯è¶…è¿‡é˜ˆå€¼
* å¹¶ä¸”æ’é™¤çº¯ä½å¤æ‚åº¦ï¼ˆpolyA/å•ç¢±åŸºrunï¼‰ä¸»å¯¼çš„ probeï¼ˆå¦åˆ™ä¼šäº§ç”Ÿå¤§é‡ä¼ªå‘½ä¸­ï¼‰

é€šè¿‡è€…è¿›å…¥åç»­ Full TE scanï¼ˆä»ç„¶æ˜¯â€œç¨€ç–â€ï¼Œåªåœ¨è§¦å‘çª—å£ä¸­å°‘æ•° reads ä¸Šåšï¼‰ã€‚

---

# 5. Full TE scanï¼ˆä»ç„¶ä¸å…¨é‡ï¼Œåªåœ¨å€™é€‰ä¸Šï¼‰

å¯¹ Gate1 é€šè¿‡çš„ readï¼š

* åªåœ¨â€œè¢«è§¦å‘çš„å±€éƒ¨åŒºæ®µâ€åšæ›´å¼ºçš„ TE åŒ¹é…ï¼š

  * å¯ç”¨ minimizer chaining æˆ–å±€éƒ¨ seed-and-extend
  * ç›®æ ‡ï¼šå®šä½ TE-like åŒºæ®µåœ¨ read ä¸Šçš„èŒƒå›´ï¼ˆstart/endï¼‰ä¸æ–¹å‘
* è¾“å‡ºï¼š

  * `te_segments = [(read_start, read_end, family, strand, score)]`
  * `breakpoint_hints`ï¼šä¸ CIGAR/SA è”åˆæ¨æ–­çš„æ–­ç‚¹å¤§è‡´ä½ç½®ï¼ˆå·¦å³ï¼‰

---

# 6. Component æ„å»ºï¼šlocus-set èšç±» + æ–­ç‚¹è§£é‡Šåˆ†è§£

åœ¨ Task Layer ä¸­å¯¹æ¯ä¸ªè§¦å‘çª—å£æ‰§è¡Œï¼š

## 6.1 åˆåˆ†æ¡¶ï¼ˆbinningï¼‰

æŒ‰å‚è€ƒåæ ‡æŠŠ reads èšåˆ° binsï¼ˆ200bp~1kb å¯è°ƒï¼‰ï¼Œé”šç‚¹ä¼˜å…ˆçº§ï¼š

1. SA/split ç«¯ç‚¹
2. å¤§ I/D äº‹ä»¶ä¸­å¿ƒ
3. è½¯å‰ªåˆ‡ç«¯ç‚¹
4. TE segment é™„è¿‘çš„å‚è€ƒç«¯ç‚¹

æ¯ä¸ª bin ä¿ç•™ï¼š

* `core_reads`ï¼ˆæŠ½æ ·ä»£è¡¨æ€§ï¼‰
* `all_evidence_summary`

## 6.2 locus-set æ„å»ºï¼ˆå—é™å€™é€‰é›†åˆï¼‰

åŸåˆ™ï¼šä¸åšå…¨åŸºå› ç»„æœç´¢ã€‚

å€™é€‰è½ç‚¹æ¥æºï¼ˆæŒ‰å¯ç”¨æ€§ï¼‰ï¼š

* read çš„ secondary/supplementaryï¼ˆè‹¥å­˜åœ¨ï¼‰
* åŒ bin å†…å…¶ä»– reads çš„è½ç‚¹é›†åˆå¹¶é›†
* TE åå‘ç´¢å¼•ï¼ˆTE k-mer â†’ genome top-L å€™é€‰åŒæºä½ç½®ï¼‰

  * è¿™é‡Œéœ€è¦ä¸€ä¸ªé¢„è®¡ç®—ç´¢å¼•ï¼šæŠŠå‚è€ƒåŸºå› ç»„çš„ minimizers å»ºè¡¨ï¼Œä½†æŸ¥è¯¢åªè¿”å› top-Lï¼ˆä¾‹å¦‚ Lâ‰¤20ï¼‰ï¼Œä¸”åªåœ¨è¯¥çª—å£è§¦å‘æ—¶æŸ¥è¯¢ã€‚

è‹¥å€™é€‰é›†åˆå¤§äº Lmaxï¼šè¯¥ bin ç›´æ¥é™çº§ï¼ˆTier3å€™é€‰ï¼‰ï¼Œåç»­ä¸åšå±€éƒ¨å†æ¯”å¯¹ã€‚

## 6.3 æ–­ç‚¹è§£é‡Šåˆ†è§£

å¯¹åŒä¸€ locus-set å†…çš„ readsï¼Œå†æŒ‰â€œæ–­ç‚¹å‡ ä½•ä¸€è‡´æ€§â€æ‹† componentï¼š

* å·¦/å³æ–­ç‚¹çš„æ–¹å‘ä¸ç›¸å¯¹ä½ç½®ä¸€è‡´
* TE segment åœ¨ read ä¸Šçš„ç›¸å¯¹ä½ç½®ä¸€è‡´
* æ”¯æŒæ’å…¥ç»“æ„çš„ split/ins æ¨¡å¼ä¸€è‡´

æ‹†ä¸å‡ºæ¥ä¸”æ˜æ˜¾æ··æ‚ï¼šé™çº§ï¼Œä¸ç»„è£…ã€‚

è¾“å‡ºï¼š`Component` åˆ—è¡¨è¿›å…¥åç»­ã€‚

---

# 7. å±€éƒ¨å†æ¯”å¯¹ï¼ˆLocal Re-alignmentï¼Œå—é™æœç´¢ç©ºé—´ï¼‰

å¯¹æ¯ä¸ª Componentï¼š

## 7.1 æœç´¢ç©ºé—´

åªå…è®¸å¯¹ component çš„å€™é€‰è½ç‚¹é›†åˆ `{locus_j}` çš„æ¯ä¸ª locus åœ¨ Â±Wï¼ˆä¾‹å¦‚ 10kbï¼‰çª—å£å†…å¯¹é½ã€‚
ç¦æ­¢å…¨åŸºå› ç»„è‡ªç”±æœç´¢ã€‚

## 7.2 è¾“å…¥åºåˆ—

ä» core_reads çš„ probe/TE segment é‚»åŸŸç‰‡æ®µä¸­é‡å»ºâ€œä¾§ç¿¼ç‰‡æ®µâ€ï¼š

* upstream flankï¼ˆå°½é‡å– 1â€“2kbï¼‰
* downstream flankï¼ˆåŒç†ï¼‰
  å¦‚æœ read ä¸å¤Ÿé•¿ï¼Œå°±å°½åŠ›å–æœ€é•¿å¯ç”¨ç‰‡æ®µï¼Œå¹¶è®°å½•é•¿åº¦ã€‚

## 7.3 å¯¹é½å™¨é€‰æ‹©

å®ç°ä¸Šå¯ä»¥ï¼š

* ç”¨ minimap2 çš„ library/API æˆ–è°ƒç”¨å­è¿›ç¨‹ï¼ˆä½†è¦æ³¨æ„ååï¼‰
* æˆ–ç”¨ edlib/ksw2 åšå±€éƒ¨åŠå…¨å±€æ¯”å¯¹ï¼ˆçª—å£å°ï¼Œé€Ÿåº¦å¯æ§ï¼‰

è¾“å‡ºï¼šæ¯æ¡ read çš„â€œè½ç‚¹è¯æ®å‘é‡â€ï¼š

* å¯¹å„ locus çš„åˆ†æ•°ã€è¾¹ç•Œã€æ–¹å‘ä¸€è‡´æ€§
* ç”¨äºåç»­ placeability ä¸ EMã€‚

---

# 8. Assemblyï¼šGraph-POAï¼ˆç»„ä»¶å†…éƒ¨ï¼Œå—é™è¾“å‡ºï¼‰

å¯¹æ¯ä¸ª Componentï¼š

## 8.1 ç»„è£…è¾“å…¥

åªç”¨ core_readsï¼Œä¸”å¿…é¡»å·²ç»é€šè¿‡â€œæ–­ç‚¹è§£é‡Šä¸€è‡´æ€§â€ã€‚
æŠŠ reads åˆ‡æˆä¸‰æ®µï¼ˆå¯ç¼ºå¤±ï¼‰ï¼š

* UpFlank
* InsertSegmentï¼ˆTE segment ä¸ºæ ¸å¿ƒï¼‰
* DownFlank

## 8.2 Graph-POA

* ä¸Š/ä¸‹æ¸¸ä¾§ç¿¼åˆ†åˆ«åš POAï¼Œä¿ç•™åˆ†å‰ä¿¡æ¯ï¼Œä½†è¾“å‡ºè·¯å¾„æ•°é‡ä¸Šé™ä¸º 2ã€‚
* æ’å…¥ä½“åªé‡å»ºå¯æ”¯æŒä¸€è‡´ç‰‡æ®µï¼›polyA ä¸ä½œä¸ºåˆ†å‰ä¾æ®ï¼Œåªè®°å½•é•¿åº¦åˆ†å¸ƒã€‚

è¾“å‡º contigsï¼š

* `contig_k = concat(UpPath_i, InsertRep, DownPath_j)`
* æœ€å¤šè¾“å‡º 2 æ¡ contigï¼ˆä»£è¡¨ä¸¤ç§ä¸»è¦ç»“æ„è·¯å¾„ï¼‰

---

# 9. Contig Collapsingï¼šç»“æ„çº§åˆå¹¶ï¼ˆv5 å¿…éœ€ï¼‰

å¯¹åŒä¸€ component äº§å‡ºçš„å¤šä¸ª contigï¼š

## 9.1 ç»“æ„ç­¾åå®šä¹‰

`structure_signature` ç”±ä»¥ä¸‹å­—æ®µæ„æˆï¼š

* å‚è€ƒè½ç‚¹å‡ ä½•ï¼šå·¦å³ä¾§ç¿¼çš„å¯¹é½ç«¯ç‚¹åŒºé—´ã€æ–¹å‘
* æ’å…¥ä½“é•¿åº¦åŒºé—´ï¼ˆç²—ç²’åº¦ï¼Œå…è®¸ polyA æ³¢åŠ¨ï¼‰
* TE å®¶æ—/æ–¹å‘
* 5â€™æˆªæ–­ç­‰çº§ï¼ˆæŒ‰é•¿åº¦æ¡¶ï¼Œä¾‹å¦‚ full / 5â€™trunc-short / trunc-longï¼‰
* å€’ç½®æˆ–åŒæ–­ç‚¹ç»“æ„æ ‡å¿—

## 9.2 åˆå¹¶è§„åˆ™

è‹¥ä¸¤ä¸ª contig çš„ç»“æ„ç­¾åç­‰åŒï¼ˆæˆ–åœ¨å®¹å¿é˜ˆå€¼å†…ï¼‰ï¼Œåˆå¹¶ä¸ºä¸€ä¸ª StructuralRepresentativeï¼š

* ä»£è¡¨åºåˆ—ï¼šç”¨ POA å…±è¯†æˆ–é€‰æ”¯æŒåº¦æœ€é«˜ contig
* å¾®å°å·®å¼‚ï¼šè¿›å…¥ polymorphism_summaryï¼ˆæ³¨é‡Šï¼‰

åªæœ‰å½“ç»“æ„å·®å¼‚æ˜¾è‘—ï¼ˆæˆªæ–­ç‚¹å·®å¼‚å¤§ã€å€’ç½®ã€æœ‰é¢å¤–æ–­ç‚¹ï¼‰æ—¶æ‰ä¿ç•™å¤šä¸ªä»£è¡¨è¿›å…¥åˆ†å‹ã€‚

---

# 10. Placeability ä¸ Tier åˆ¤å®š

å¯¹æ¯ä¸ª StructuralRepresentativeï¼š

è®¡ç®— `PlaceabilityScore`ï¼š

* `Î”`ï¼šæœ€ä½³ locus ä¸æ¬¡ä½³ locus çš„å¯¹é½åˆ†å·®
* `SideConsistency`ï¼šä¸Š/ä¸‹æ¸¸ä¾§ç¿¼æ˜¯å¦ä¸€è‡´æ”¯æŒåŒä¸€ locus
* `SupportConsistency`ï¼šæ”¯æŒ reads åœ¨ locus ä¸Šçš„åˆ†æ•°åˆ†å¸ƒæ˜¯å¦é›†ä¸­
* `CandidateSetSizePenalty`ï¼šå€™é€‰é›†åˆè¶Šå¤§æƒ©ç½šè¶Šå¤§

Tierï¼š

* Tier1ï¼šå€™é€‰é›†åˆå°ä¸”åˆ†å·®å¤§ï¼Œä¾§ç¿¼ä¸€è‡´
* Tier2ï¼šå¤šä¸ªç­‰ä»· locusï¼ˆåˆ†å·®å°æˆ–é›†åˆå¤§ï¼‰ï¼Œä½†ç»“æ„è§£é‡Šä¸€è‡´
* Tier3ï¼šæ— æ³•ç¨³å®šè½ç‚¹æˆ–ç»„ä»¶æ··æ‚

æ–­ç‚¹è¾“å‡ºï¼š

* é»˜è®¤è¾“å‡ºåŒºé—´ï¼ˆè·¨ reads çš„ä¸€è‡´åŒºé—´ï¼‰
* åªæœ‰ä¸€è‡´æ€§è¶³å¤Ÿé«˜æ‰è¾“å‡ºå•ç‚¹

TSDï¼š

* ä»… Tier1 ä¸”æ–­ç‚¹ç¨³å®šæ—¶æ£€æµ‹
* å¹¶åšçŸ­é‡å¤èƒŒæ™¯æ˜¾è‘—æ€§è¿‡æ»¤ï¼ˆå¦åˆ™ TSD=NAï¼‰

---

# 11. Genotypingï¼šEM(ALT/REF/NULL) + ç©ºé—´å…ˆéªŒ + ç»“æ„å…ˆéªŒï¼ˆv5 æ ¸å¿ƒï¼‰

å¯¹æ¯ä¸ª Tier1ï¼ˆæˆ– placeability è¶³å¤Ÿé«˜çš„ Tier2ï¼ŒæŒ‰ç­–ç•¥ï¼‰åšåˆ†å‹ã€‚

## 11.1 ç»„ä»¶

* ALT_structï¼šæ’å…¥å­˜åœ¨ï¼Œç»“æ„ä¸ºå½“å‰ StructuralRepresentative
* REFï¼šæ— æ’å…¥
* NULLï¼šèƒŒæ™¯/å…¶ä»–ä½ç‚¹/ä¸å¯è§£é‡Š

## 11.2 ä¼¼ç„¶é¡¹ï¼ˆå¿…é¡»å¯è®¡ç®—ï¼‰

å¯¹æ¯æ¡ read è®¡ç®—ç‰¹å¾ï¼š

* `d_spatial = |x_read_primary - x0|`ï¼ˆx0 ä¸ºå€™é€‰ä½ç‚¹ä¸­å¿ƒæˆ–é›†åˆå†…æŸ locusï¼‰
* `geom_ok`ï¼šæ˜¯å¦æ»¡è¶³æ–­ç‚¹å‡ ä½•è§£é‡Šï¼ˆsplit/ins æ¨¡å¼ä¸€è‡´ã€TE segment æ–¹ä½ä¸€è‡´ï¼‰
* `align_scores`ï¼šå¯¹å€™é€‰ locus çš„å±€éƒ¨å¯¹é½åˆ†æ•°ä¸ä¸€è‡´æ€§
* `contig_support`ï¼šread æ˜¯å¦ä¸æ’å…¥ä»£è¡¨ä¸€è‡´ï¼ˆä¸éœ€è¦é€ç¢±åŸºé«˜ç²¾åº¦ï¼Œå…è®¸ç”¨ç§å­ä¸€è‡´æ€§+ç²—å¯¹é½ï¼‰

å®šä¹‰ï¼š

* `P(data | ALT)`ï¼šéœ€è¦ geom_ok é«˜ã€contig_support é«˜ã€ä¸”åœ¨å€™é€‰ locus ä¸Šå¯¹é½ä¸€è‡´
* `P(data | REF)`ï¼šéœ€è¦è·¨æ–­ç‚¹è¿ç»­è§£é‡Šæ›´ä¼˜ã€æ— æ’å…¥è¯æ®
* `P(data | NULL)`ï¼šgeom_ok ä½æˆ–å¯¹é½åˆ†æ•£æˆ–æ›´ç¬¦åˆâ€œè¿œç«¯æ¥æºâ€

## 11.3 å…ˆéªŒï¼ˆè§£å†³ nested insertion NULL åå™¬ï¼‰

ç©ºé—´å…ˆéªŒï¼š

* `Ï€_ALT âˆ exp(-d_spatial/Î») * f(geom_ok)`
* `Ï€_REF âˆ exp(-d_spatial/Î») * f(ref_span_ok)`
* `Ï€_NULL âˆ c + (1 - exp(-d_spatial/Î»))`

ç»“æ„å…ˆéªŒï¼š

* å¦‚æœ read çš„ TE family vote ä¸è¯¥ä½ç‚¹ä»£è¡¨ä¸€è‡´ï¼Œä¸Šè°ƒ ALT å…ˆéªŒ
* å¦‚æœ family vote åˆ†æ•£ï¼Œä¸Šè°ƒ NULL

## 11.4 EM æ›´æ–°ä¸æ”¶æ•›

* åˆå§‹åŒ–ï¼šALT/REF æŒ‰ç›´è§‰è®¡æ•°ï¼ˆsplit/ins è¯»ç»™ ALT åˆå€¼ï¼Œè¿ç»­è·¨è¶Šç»™ REFï¼‰
* E-stepï¼šç®—æ¯æ¡ read çš„åéªŒè´£ä»»åº¦ `Î³_alt, Î³_ref, Î³_null`
* M-stepï¼šæ›´æ–° ALT fractionï¼ˆå¹¶è¾“å‡º Beta-Binomial çš„åéªŒåŒºé—´ï¼‰
* ç»ˆæ­¢ï¼šå¯¹æ•°ä¼¼ç„¶å¢ç›Š < Îµ æˆ–è¿­ä»£æ¬¡æ•°è¾¾ä¸Šé™ï¼ˆä¾‹å¦‚ 20ï¼‰

è¾“å‡ºï¼š

* `E[ALT], E[REF], E[NULL]`
* `AF = E[ALT]/(E[ALT]+E[REF])` åŠå¯ä¿¡åŒºé—´
* `GQ`ï¼šåŸºå› å‹ä¼¼ç„¶æ¯”è½¬ Phred
* åˆ¤å®šï¼š

  * è‹¥ `E[ALT]` ç»“æ„ä¸€è‡´ä¸” AF æ˜ç¡®ï¼š0/1 æˆ– 1/1
  * è‹¥ `E[NULL]` æé«˜ä¸” `E[ALT]` æ— ç»“æ„ä¸€è‡´ï¼šNG
  * nested insertion åœºæ™¯ï¼šå…è®¸ `E[NULL]` é«˜ä½† `E[ALT]` ç»“æ„ä¸€è‡´ä»è¾“å‡ºä½GQ callï¼ˆæ ‡è®° HIGH_BACKGROUNDï¼‰

---

# 12. è¾“å‡ºè§„èŒƒï¼ˆé¿å…è¯¯å¯¼ï¼‰

## scientific.vcfï¼ˆä¸»è¾“å‡ºï¼‰

* Tier1ï¼šå•åæ ‡
* Tier2ï¼šç”¨å¤šè®°å½•æˆ–é›†åˆå­—æ®µè¡¨è¾¾

  * æ–¹æ¡ˆ Aï¼šæ¯ä¸ªå€™é€‰ locus ä¸€æ¡ VCF è®°å½•ï¼Œå…±äº« `LOCUS_SET_ID`
  * æ–¹æ¡ˆ Bï¼šä¸€ä¸ªä¸»è®°å½• + `ALT_LOCI=chr:pos,chr:pos...`ï¼ˆä¸æ¨èç»™ä¸‹æ¸¸å·¥å…·ï¼‰
* Tier3ï¼šä¸è¾“å‡ºåæ ‡è®°å½•ï¼Œè¾“å‡ºåˆ° `evidence.tsv`ï¼ˆå«è¯æ®IDã€TEå®¶æ—ã€è¯»æ”¯æŒæ‘˜è¦ï¼‰

INFO å­—æ®µå»ºè®®ï¼š

* `TIER`
* `LOCUS_SET_ID`
* `PLACEABILITY`
* `BP_CI_L/BP_CI_R`
* `TSD_LEN/TSD_SEQ/TSD_BG_P`
* `TE_FAMILY/TE_ORIENT/TE_COV`
* `POLYA_CI`
* `EALT/EREF/ENULL`
* `AF_CI`
* `GQ`
* `FLAGS=HIGH_BACKGROUND|LOW_COMPLEXITY|HOTSPOT|...`

## engineering è¾“å‡ºï¼ˆé»˜è®¤ä¸æä¾›ä»£è¡¨åæ ‡ï¼‰

* æä¾›ï¼š

  * `LOCUS_SET_ID`
  * `CANDIDATE_LOCI_LIST`
  * `PRIMER_DESIGN_HINT`: â€œuse locus-set list, not single coordinateâ€
    å¦‚æœç”¨æˆ·æ˜¾å¼å¯ç”¨ `--emit-representative-locus`ï¼š
* è¾“å‡º `REP_LOCUS`ï¼Œä½†å¼ºåˆ¶é™„å¸¦ `REP_IS_NOT_GROUND_TRUTH=1`

---

# 13. æ€§èƒ½ä¸å¤æ‚åº¦ï¼ˆå†™è¿›è®¾è®¡æ–‡æ¡£ï¼Œé¿å…â€œä»£ä»·æ˜¯è°œâ€ï¼‰

å…³é”®æˆæœ¬æ¥è‡ªä¸‰å¤„ï¼š

1. å•é BAM è§£å‹ä¸è§£æï¼ˆçº¿æ€§ï¼‰
2. Gate 1 TE-proxyï¼ˆåªå¯¹è§¦å‘çª—å£ç¼“å†²å†…å°‘æ•° read çš„å°‘æ•°çŸ­ç‰‡æ®µï¼‰
3. å±€éƒ¨å†æ¯”å¯¹ä¸ POAï¼ˆåªå¯¹è§¦å‘ç»„ä»¶çš„ core_readsï¼Œä¸”å€™é€‰ locus é›†åˆå—é™ï¼‰

æˆæœ¬æ§åˆ¶æ‰‹æ®µå…¨éƒ¨æ˜¾å¼åŒ–ï¼š

* è§¦å‘é˜ˆå€¼æ˜¯åˆ†ä½ç»Ÿè®¡è€Œä¸æ˜¯å…¨é‡æ‰«æåå›è¯»
* æ¯çª—å£ç¼“å†²ä¸ core_reads ä¸Šé™
* å€™é€‰ locus é›†åˆ Lmaxï¼Œè¶…å‡ºç›´æ¥é™çº§
* POA è¾“å‡ºè·¯å¾„ä¸Šé™
* EM è¿­ä»£æ¬¡æ•°ä¸Šé™

---

# 14. å®ç°é¡ºåºï¼ˆæœ€çŸ­å¯ç”¨äº§å“åˆ°å®Œæ•´ä½“ï¼‰

1. Stream + WindowBuffer + Triggerï¼ˆä¸åš TE-proxyï¼Œå…ˆåªç”¨ CIGAR/SA/clip è§¦å‘ï¼‰
2. Gate1ï¼ˆç«¯éƒ¨ + clip + I/D æ¢é’ˆï¼‰+ TE k-mer ç´¢å¼•
3. Component æ„å»º + å—é™å€™é€‰é›†åˆï¼ˆå…ˆç”¨ secondary/åŒçª—å¹¶é›†ï¼Œä¸åš TEåå‘ç´¢å¼•ï¼‰
4. å±€éƒ¨å†æ¯”å¯¹ï¼ˆå€™é€‰ locus Â±10kbï¼‰
5. POA ç»„è£… + ç»“æ„çº§åˆå¹¶
6. Placeability + Tier è¾“å‡º
7. EM(ALT/REF/NULL) + ç©ºé—´å…ˆéªŒ
8. TEåå‘ç´¢å¼•ï¼ˆæå‡ç¼º secondary çš„åœºæ™¯å¬å›ï¼‰
9. å¯é€‰ï¼šMD å³°åŠ é€Ÿå™¨

---

# 15. åŸç†æ€»ç»“ï¼ˆæ¯ä¸ªå…³é”®é€‰æ‹©çš„å› æœé“¾ï¼‰

* å•éæµå¼ï¼šæŠŠ I/O ä»â€œ2æ¬¡è§£å‹BAMâ€é™ä¸ºâ€œ1æ¬¡é¡ºåºè§£å‹ + åç»­åªå¤„ç†ç¼“å­˜ç‰‡æ®µâ€ï¼Œè¿™æ˜¯å¤§æ–‡ä»¶çš„å†³å®šæ€§æ”¶ç›Šã€‚
* Gate1 æ¢é’ˆï¼šç”¨å°‘é‡çŸ­ç‰‡æ®µçš„ TE-proxy æŠŠ full scan é™åˆ¶åœ¨ç¨€ç–é›†åˆï¼Œé¿å…æ‰«æåŠä¸ª BAMã€‚
* å—é™å€™é€‰é›†åˆï¼šå±€éƒ¨å†æ¯”å¯¹åªåœ¨å€™é€‰ locus å‘¨å›´åšï¼Œé¿å…æŠŠå·¥å…·å˜æˆ aligner wrapperã€‚
* ç»“æ„çº§åˆå¹¶ï¼šç»„è£…å¯å¤šè§£ï¼Œä½†åˆ†å‹åªæ¥å—ç»“æ„å‡è®¾ï¼Œä¸è®©å¾®å°å·®å¼‚æ‹–å® EMã€‚
* NULL + ç©ºé—´å…ˆéªŒï¼šæ—¢é¿å… closed-world å¼ºè¡Œåˆ†é…ï¼Œåˆé¿å…é‡å¤åŒºæŠŠçœŸå®å±€éƒ¨ä¿¡å·å…¨å¸è¿› NULLã€‚

ä»¥ä¸Šæ˜¯ v5 çš„â€œèƒ½å†™ä»£ç â€çš„ç‰ˆæœ¬ã€‚æŒ‰è¿™ä¸ªæ‹†åˆ†å†™å®ç°ï¼Œæ¯ä¸ªæ¨¡å—éƒ½æœ‰æ˜ç¡®è¾“å…¥è¾“å‡ºã€é™çº§è·¯å¾„å’Œæ€§èƒ½è¾¹ç•Œï¼Œä¸ä¼šå†å‡ºç°â€œç†è®ºä¸Šå¾ˆå¥½ä½†å·¥ç¨‹ä¸Šå†™ä¸å‡ºæ¥â€çš„ç©ºæ´ç¯èŠ‚ã€‚



# 16. å¼€å‘è®¡åˆ’ï¼ˆè¯¦ç»†å®ç°ç‰ˆï¼‰
Phase 1: åŸºç¡€è®¾æ–½ (Stream + WindowBuffer + Trigger)

ç›®æ ‡ï¼šæ„å»ºå•æ¬¡æµå¼éå†çš„éª¨æ¶ï¼Œå®ç°å†…å­˜å®‰å…¨çš„æ»‘åŠ¨çª—å£ä¸è‡ªé€‚åº”è§¦å‘ã€‚

å®ç°ç»†èŠ‚ï¼š

BamReaderï¼šå°è£… htslibï¼Œå¯ç”¨å¤šçº¿ç¨‹è§£å‹ (hts_set_threads)ã€‚å¿…é¡»è§£æ BAM_FSUPPLEMENTARY (0x800)ï¼Œä»…è¿‡æ»¤ Secondaryã€‚

WindowBuffer å†…å­˜ç®¡ç†ï¼šå®ç°â€œSafe Frontierâ€é€»è¾‘ã€‚ç»´æŠ¤ä¸€ä¸ª safe_pos æŒ‡é’ˆï¼Œæ‰€æœ‰ end_pos < safe_pos çš„çª—å£å¯¹è±¡å¿…é¡»è¢«ç‰©ç†ææ„å¹¶ç§»å‡º Mapï¼Œé˜²æ­¢å†…å­˜éšæŸ“è‰²ä½“é•¿åº¦çº¿æ€§å¢é•¿ã€‚

è‡ªé€‚åº”é˜ˆå€¼ (PÂ² Algorithm)ï¼šä½¿ç”¨ PÂ² ç®—æ³•ï¼ˆæˆ– t-digestï¼‰åœ¨çº¿ä¼°ç®— clip/SA/ins çš„ Q99 åˆ†ä½æ•°ã€‚é¿å…ç¡¬ç¼–ç é˜ˆå€¼å¯¼è‡´åœ¨ä¸åŒæµ‹åºæ·±åº¦ä¸‹å¤±æ•ˆã€‚

ä»»åŠ¡åºåˆ—åŒ–ï¼šTaskQueue å¿…é¡»æ”¯æŒå°† Read ç‰‡æ®µå’Œå…ƒæ•°æ®åºåˆ—åŒ–åˆ°å†…å­˜å—æˆ–ä¸´æ—¶æ–‡ä»¶ï¼ˆè‹¥å†…å­˜å‹åŠ›å¤§ï¼‰ï¼Œç¡®ä¿ Worker çº¿ç¨‹ä¸éœ€è¦å›è¯» BAMã€‚

æ ¸å¿ƒçº¦æŸï¼š

ç¦æ­¢ Seekï¼šBamReader åªèƒ½é¡ºåº sam_read1ã€‚

O(1) æŸ¥æ‰¾ï¼šçª—å£ ID ä½¿ç”¨ (tid << 32) | (pos / window_size) çš„æ•´æ•° Keyï¼Œç¦æ­¢å­—ç¬¦ä¸²æ‹¼æ¥ã€‚

Phase 2: Gate 1 (TE-proxy åˆç­›)

ç›®æ ‡ï¼šåœ¨ä¸è¿›è¡Œå…¨é‡æ¯”å¯¹çš„å‰æä¸‹ï¼Œé€šè¿‡å»‰ä»·æ¢é’ˆå¿«é€Ÿè¯†åˆ« TE ä¿¡å·ï¼Œè¿‡æ»¤ 99% çš„èƒŒæ™¯å™ªéŸ³ã€‚

å®ç°ç»†èŠ‚ï¼š

ProbeFragment æå–å™¨ï¼š

å¯¹æ¯æ¡ Readï¼Œæå– 5' å’Œ 3' ç«¯éƒ¨ (200bp)ã€‚

æ‰«æ CIGARï¼Œå¯¹ I > 50bp æˆ– S > 200bp çš„åŒºåŸŸæå–é‚»åŸŸåºåˆ—ã€‚

è‹¥ MD tag å­˜åœ¨ï¼Œæå–é”™é…å¯†é›†åŒºï¼ˆTop-2 peaksï¼‰ã€‚

TE ç´¢å¼•æ„å»ºï¼š

å¯¹ te.fa æ„å»º Minimizer Sketch (k=15, w=10)ï¼Œå…è®¸ä¸€å®šå®¹é”™ã€‚ä¸è¿½æ±‚å”¯ä¸€æ¯”å¯¹ï¼Œåªè¿½æ±‚â€œå‘½ä¸­å¯†åº¦â€ã€‚

å»ºç«‹ FamilyMapï¼šMinimizer Hash -> TE Family IDã€‚

Proxy è¯„åˆ†ï¼š

è®¡ç®— Probe çš„ Hit Density (matches / bp)ã€‚

é€»è¾‘é—¨ï¼šif (max_density > 0.2 || total_hits > threshold) pass;

æ ¸å¿ƒçº¦æŸï¼š

ç¨€ç–æ€§ï¼šä¸¥ç¦å¯¹æ•´æ¡ Read åš Minimizer æ‰«æã€‚åªæ‰«ææå–å‡ºçš„ Probe ç‰‡æ®µã€‚

ä½å¤æ‚åº¦è¿‡æ»¤ï¼šåœ¨ç´¢å¼•æ„å»ºé˜¶æ®µè¿‡æ»¤æ‰ PolyA/PolyT çš„ k-merï¼Œé˜²æ­¢ç”± Homopolymer é€ æˆçš„å‡é˜³æ€§è§¦å‘ã€‚

Phase 3: Component æ„å»º (Binning & Clustering)

ç›®æ ‡ï¼šå°†æ‚ä¹±çš„ Reads æ•´ç†ä¸ºå¯è§£é‡Šçš„äº‹ä»¶ç°‡ï¼Œå¹¶é™å®šæœç´¢ç©ºé—´ã€‚

å®ç°ç»†èŠ‚ï¼š

Binning ç­–ç•¥ï¼š

ä»¥ 200bp ä¸ºå•ä½ç½‘æ ¼åŒ–ã€‚Read å½’å±ç”±â€œå¼ºé”šç‚¹â€å†³å®šï¼ˆSAæ–­ç‚¹ > Clipç‚¹ > TE-hitç‚¹ï¼‰ã€‚

Locus-set ç”Ÿæˆ (å—é™é›†åˆ)ï¼š

æ”¶é›† Bin å†…æ‰€æœ‰ Reads çš„ SA ç›®æ ‡ä½ç½®ã€‚

æ”¶é›† Secondary Alignment ä½ç½®ã€‚

(Phase 8) æŸ¥è¯¢ TE åå‘ç´¢å¼•ã€‚

åˆå¹¶ä¸Šè¿°ä½ç½®ï¼Œå»é‡å¹¶èšç±»ï¼ˆè·ç¦» < 500bp å½’ä¸€ï¼‰ã€‚

ä¸€è‡´æ€§åˆ†è§£ï¼š

æ£€æŸ¥ Reads çš„æ–¹å‘ï¼ˆStrandï¼‰å’Œæ–­ç‚¹ä¾§ï¼ˆLeft/Rightï¼‰æ˜¯å¦çŸ›ç›¾ã€‚è‹¥çŸ›ç›¾ä¸”æ— æ³•æ‹†åˆ†ï¼Œæ ‡è®°ä¸º AMBIGUOUS_MIXED å¹¶é™çº§ã€‚

æ ¸å¿ƒçº¦æŸï¼š

Lmax ä¸Šé™ï¼šè‹¥å• Component çš„å€™é€‰è½ç‚¹é›†åˆ size > 20ï¼Œç›´æ¥æ ‡è®°ä¸º Tier3ï¼Œä¸å†è¿›å…¥ Phase 4ï¼Œé˜²æ­¢è®¡ç®—çˆ†ç‚¸ã€‚

Phase 4: å±€éƒ¨å†æ¯”å¯¹ (Restricted Local Re-alignment)

ç›®æ ‡ï¼šåœ¨å—é™çš„å€™é€‰åŒºåŸŸå†…ç²¾ç¡®å®šä½æ–­ç‚¹ï¼Œä¸ä¾èµ–å…¨å±€æ¯”å¯¹å™¨ã€‚

å®ç°ç»†èŠ‚ï¼š

ä¾§ç¿¼æå–ï¼šä» Core Reads ä¸­æå– Upstream/Downstream Flank (1-2kb)ã€‚

å—é™å¯¹é½ï¼š

ä½¿ç”¨ edlib æˆ– ksw2ã€‚

Target ä»…ä¸º Locus-set é‡Œçš„å€™é€‰ä½ç½® 
Â±
10
ğ‘˜
ğ‘
Â±10kb çª—å£ã€‚

æ¨¡å¼ï¼šExtension Alignment (åŠå…¨å±€)ã€‚

è¯æ®å‘é‡ï¼šä¸ºæ¯æ¡ Read ç”Ÿæˆ vector<Score>ï¼Œè®°å½•å…¶å¯¹æ¯ä¸ª Locus çš„æ”¯æŒåº¦ã€‚

æ ¸å¿ƒçº¦æŸï¼š

ç¦æ­¢å…¨å±€æœç´¢ï¼šä¸¥ç¦åŠ è½½å…¨åŸºå› ç»„ç´¢å¼•è¿›è¡Œéšæœºæ¯”å¯¹ã€‚å¿…é¡»ä¾èµ– Phase 3 æä¾›çš„å€™é€‰åˆ—è¡¨ã€‚

Phase 5: Assembly + Collapsing (Graph-POA)

ç›®æ ‡ï¼šç”Ÿæˆä»£è¡¨æ€§åºåˆ—ï¼Œå¹¶åœ¨è¿›å…¥åˆ†å‹å‰æ¶ˆé™¤å¾®å°å˜å¼‚çš„å¹²æ‰°ã€‚

å®ç°ç»†èŠ‚ï¼š

åˆ†æ®µç»„è£…ï¼šå°† Reads åˆ‡åˆ†ä¸º Up-Flank, Insert, Down-Flank ä¸‰éƒ¨åˆ†åˆ†åˆ«ç»„è£…ã€‚

Graph-POAï¼šä½¿ç”¨ abPOA æˆ– spoaã€‚ä¿ç•™åˆ†å‰å›¾ç»“æ„ï¼Œä»ä¸­æå– Top-2 æœ€ä¼˜è·¯å¾„ã€‚

ç»“æ„çº§åˆå¹¶ (Structural Identity)ï¼š

å®šä¹‰ç»“æ„æŒ‡çº¹ï¼š{Breakpoint_L, Breakpoint_R, TE_Family, Orientation, 5'_Trunc_Level}ã€‚

å¿½ç•¥ PolyA é•¿åº¦å·®å¼‚å’Œ SNP å·®å¼‚è¿›è¡Œåˆå¹¶ã€‚

äº§å‡º StructuralRepresentativeã€‚

æ ¸å¿ƒçº¦æŸï¼š

æ·±åº¦æ§åˆ¶ï¼šè¿›å…¥ POA çš„ Reads æ•°é‡å¿…é¡»æœ‰ç¡¬ä¸Šé™ï¼ˆå¦‚ 50ï¼‰ï¼Œéœ€é‡‡ç”¨åˆ†å±‚æŠ½æ ·ï¼ˆStratified Samplingï¼‰ä¿ç•™å¤šæ ·æ€§ã€‚

Phase 6: Placeability + Tier åˆ¤å®š

ç›®æ ‡ï¼šç§‘å­¦åœ°é‡åŒ–å®šä½çš„ä¸ç¡®å®šæ€§ã€‚

å®ç°ç»†èŠ‚ï¼š

Placeability Scoreï¼šè®¡ç®— Score(Best) - Score(2ndBest)ã€‚

Side Consistencyï¼šæ£€æŸ¥å·¦ä¾§ç¿¼å’Œå³ä¾§ç¿¼çš„æœ€ä½³è½ç‚¹æ˜¯å¦æŒ‡å‘åŒä¸€åŸºå› ç»„ä½ç½®ï¼ˆè·ç¦» < Gapé˜ˆå€¼ï¼‰ã€‚

Tier è§„åˆ™ï¼š

Tier 1: Unique placement (
Î”
>
30
Î”>30), Consistent sides.

Tier 2: Multiple placements (
Î”
<
10
Î”<10), Consistent structure.

Tier 3: Inconsistent or Unmappable.

æ ¸å¿ƒçº¦æŸï¼š

TSD éªŒè¯ï¼šä»…åœ¨ Tier 1 ä¸”æ–­ç‚¹æ˜ç¡®æ—¶è¿›è¡Œ TSD æœç´¢ã€‚éœ€è®¡ç®— TSD åºåˆ—åœ¨å±€éƒ¨èƒŒæ™¯ä¸­çš„å‡ºç°é¢‘ç‡ï¼Œé˜²æ­¢å°†éšæœºå¾®é‡å¤è¯¯åˆ¤ä¸º TSDã€‚

Phase 7: Genotyping (EM with Spatial Priors)

ç›®æ ‡ï¼šåœ¨å¤æ‚åŒºåŸŸå‡†ç¡®åˆ†å‹ï¼Œè§£å†³ Nested Insertion çš„èƒŒæ™¯åå™¬é—®é¢˜ã€‚

å®ç°ç»†èŠ‚ï¼š

æ¨¡å‹ç»„ä»¶ï¼šæ„å»º Mixture Model P(Data) = w_alt * P(D|ALT) + w_ref * P(D|REF) + w_null * P(D|NULL)ã€‚

ç©ºé—´å…ˆéªŒ (Spatial Prior)ï¼š

ğœ‹
ğ´
ğ¿
ğ‘‡
/
ğ‘…
ğ¸
ğ¹
âˆ
exp
â¡
(
âˆ’
ğ‘‘
ğ‘–
ğ‘ 
ğ‘¡
ğ‘
ğ‘›
ğ‘
ğ‘’
/
ğœ†
)
Ï€
ALT/REF
	â€‹

âˆexp(âˆ’distance/Î»)

ğœ‹
ğ‘
ğ‘ˆ
ğ¿
ğ¿
âˆ
1
âˆ’
exp
â¡
(
âˆ’
ğ‘‘
ğ‘–
ğ‘ 
ğ‘¡
ğ‘
ğ‘›
ğ‘
ğ‘’
/
ğœ†
)
+
base_noise
Ï€
NULL
	â€‹

âˆ1âˆ’exp(âˆ’distance/Î»)+base_noise

ç»“æ„å…ˆéªŒï¼šè‹¥ Read çš„ TE å®¶æ—ä¸ Representative ä¸ä¸€è‡´ï¼Œå¼ºåˆ¶å‹ä½å…¶åœ¨ ALT ä¸­çš„ä¼¼ç„¶ã€‚

EM è¿­ä»£ï¼šè¿è¡Œ 10-20 è½®ï¼Œè¾“å‡ºæœ€ç»ˆçš„æœŸæœ›è®¡æ•° E[ALT], E[REF], E[NULL]ã€‚

æ ¸å¿ƒçº¦æŸï¼š

NULL Sinkï¼šNULL ç»„ä»¶å¿…é¡»å­˜åœ¨ä¸”å…·å¤‡â€œå¸çº³è¿œç«¯/æ‚ä¹± Readsâ€çš„èƒ½åŠ›ã€‚

NG åˆ¤å®šï¼šè‹¥ E[NULL] å æ¯”è¿‡é«˜ï¼ˆ>50%ï¼‰ä¸” ALT æ— æ˜¾è‘—èšé›†ï¼Œè¾“å‡º GQ=0 æˆ– GT=./.ã€‚

Phase 8: é«˜çº§ä¼˜åŒ– (Optional)

ç›®æ ‡ï¼šæå‡æç«¯æƒ…å†µä¸‹çš„å¬å›ç‡å’Œé€Ÿåº¦ã€‚

å®ç°ç»†èŠ‚ï¼š

TE åå‘ç´¢å¼•ï¼šé¢„è®¡ç®— TE k-mer åœ¨å‚è€ƒåŸºå› ç»„ä¸Šçš„å‡ºç°ä½ç½®ï¼ˆä»…ä¿ç•™ Top-20 hitsï¼‰ã€‚ç”¨äºæŒ½æ•‘æ²¡æœ‰ Secondary Alignment çš„ Readsã€‚

MD åŠ é€Ÿï¼šå¦‚æœ BAM å¤´å£°æ˜äº† MD tagï¼Œåˆ™åœ¨ Gate 1 å¯ç”¨ Mismatch å¯†åº¦å³°æ£€æµ‹ã€‚


# 17. å¼€å‘æ—¥å¿—

## 2026-02-03
- é¡¹ç›®åˆå§‹åŒ–ï¼Œåˆ›å»º README.md å’Œå¼€å‘æ–¹æ¡ˆæ–‡æ¡£
- ç¡®å®š PLACER æ ¸å¿ƒæ¶æ„: ä¸‰å±‚æ¶æ„ (Stream/Task/Output)
- ç¡®å®šå…³é”®æŠ€æœ¯è·¯çº¿: å•éæµå¼ã€Gate1 TE-proxyã€å—é™å€™é€‰é›†åˆã€EM genotyping

## 2026-02-04
### Phase 1: åŸºç¡€è®¾æ–½ (Stream + WindowBuffer + Trigger) - å¼€å‘ä¸­

#### å·²å®Œæˆ:
- [x] é¡¹ç›®ç»“æ„æ­å»º (CMakeLists.txt, include/, src/stream/)
- [x] BamReader ç±»å®ç° - å•é BAM è§£æ, ReadSketch ç»“æ„
- [x] WindowBuffer ç±»å®ç° - æ»‘åŠ¨çª—å£, ç»Ÿè®¡æ”¶é›†, è§¦å‘é€»è¾‘
- [x] WindowStats ç±»å®ç° - P^2 åœ¨çº¿åˆ†ä½æ•°ä¼°è®¡ç®—æ³•
- [x] Trigger ç±»å®ç° - é˜ˆå€¼è§¦å‘è¯„ä¼°
- [x] TaskQueue ç±»å®ç° - å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—æ¡†æ¶
- [x] Phase 1 æµ‹è¯•ç”¨ä¾‹ - å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯•

#### æ ¸å¿ƒæ–‡ä»¶:
- `include/bam_reader.h/cpp` - BAM è§£ææ¨¡å—
- `include/window_buffer.h/cpp` - æ»‘åŠ¨çª—å£ç¼“å†²
- `include/window_stats.h/cpp` - çª—å£ç»Ÿè®¡å™¨
- `include/trigger.h/cpp` - è§¦å‘å™¨
- `include/task_queue.h/cpp` - ä»»åŠ¡é˜Ÿåˆ—
- `tests/test_stream.cpp` - Phase 1 æµ‹è¯•

#### æµ‹è¯•æ•°æ®:
- BAM: `/mnt/home1/miska/hl725/projects/tldr_optimized/test/test.bam`
- REF: `/mnt/home1/miska/hl725/projects/tldr_optimized/test/ref.fa`
- ç›®æ ‡åŒºåŸŸ: `chrTEST:90777-90789`

## 2026-02-03 (ä»£ç ä¿®å¤)

### å·²ä¿®å¤é—®é¢˜

1. **BamReader SA è§£æ**
   - ä¿®å¤æŒ‡é’ˆç®—æœ¯å´©æºƒï¼š`comma1 - strlen(comma1)` â†’ `rname_buffer.assign()`
   - ä¿®å¤ TID æŸ¥æ‰¾ï¼šä½¿ç”¨ `sam_hdr_name2tid()` è¿›è¡Œ header æŸ¥æ‰¾
   - ä¿®å¤ä½ç½®åŸºå‡†ï¼šSA 1-based è½¬ 0-based
   - ReadSketch å¤ç”¨ä¼˜åŒ–ï¼šå‡å°‘å†…å­˜åˆ†é…

2. **Trigger æ¨¡å—**
   - ä¿®å¤é™¤é›¶é£é™©ï¼š`max(q99 * factor, baseline)` åŒé‡ä¿æŠ¤
   - æ·»åŠ åŸºçº¿é˜ˆå€¼ï¼š`min_baseline_clip = 50.0` ç­‰
   - åˆå¹¶ evaluate/check_conditionsï¼šæ¶ˆé™¤å†—ä½™è°ƒç”¨

3. **æµ‹è¯•ä¸ç¼–è¯‘**
   - API åŒæ­¥æ›´æ–°ï¼š`read.read_id` â†’ `read.qname`ï¼Œ`read.end` â†’ `read.end_pos`
   - æ·»åŠ  q99 å­—æ®µåˆ° WindowStats
   - ä¿®å¤ WindowBuffer æ„é€ å‡½æ•°ä¸ get_stats æ–¹æ³•

### æµ‹è¯•ç»“æœ
```
=== PLACER Phase 1 Tests ===
Testing WindowStats... PASS
Testing BamReader... 79 records processed
Testing WindowBuffer... 3 windows created
Testing Trigger... Score=1, triggered
Testing TaskQueue... All tasks processed
Testing integration... PASS

=== All tests passed! ===
```
